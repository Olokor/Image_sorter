{% extends "base.html" %}

{% block title %}Share Photos - TLP Photo App{% endblock %}

{% block extra_css %}
<style>
    .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }
    .qr-display {
        margin: 20px 0;
        text-align: center;
    }
    .qr-display img {
        border: 2px solid #E8E8E8;
        border-radius: 8px;
        max-width: 280px;
    }
    .share-url {
        background: #F8F9FA;
        padding: 15px;
        border-radius: 8px;
        word-break: break-all;
        font-family: monospace;
        font-size: 13px;
        margin: 15px 0;
        border: 1px solid #E8E8E8;
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>📱 Share Photos via QR Code</h1>
</div>

<div class="two-column">
    <div class="card p-3">
        <h2 class="mb-3">Generate Share Link</h2>

        <!-- Search Student -->
        <form id="searchForm" class="mb-3">
            <label>Student State Code *</label>
            <input type="text" id="stateCodeInput" class="form-control" placeholder="Enter state code..." required>
            <button class="btn btn-primary w-100 mt-2">🔍 Find Student</button>
        </form>

        <!-- Student Info -->
        <div id="studentInfo" class="bg-success-subtle p-3 rounded" style="display:none;">
            <p class="mb-1 fw-bold" id="studentName"></p>
            <small class="text-dark"><strong>📷 Gallery Photos:</strong> <span id="studentPhotos">0</span></small>
        </div>

        <!-- QR Settings -->
        <form id="generateForm" class="mt-4">
            <label>Link Expiry (Hours)</label>
            <input type="number" id="expiryHours" class="form-control" value="24" min="1" max="168">

            <label class="mt-2">Download Limit</label>
            <input type="number" id="downloadLimit" class="form-control" value="50" min="1" max="1000">

            <button class="btn btn-success w-100 mt-3" id="generateBtn">📱 Generate QR Code</button>
        </form>

        <!-- QR Result -->
        <div id="qrResult" style="display:none;" class="mt-4">
            <h3 class="text-success text-center">✓ QR Code Ready</h3>

            <div class="qr-display">
                <img id="qrImage" />
            </div>

            <div class="share-url" id="shareUrl"></div>

            <div class="d-flex gap-2">
                <button class="btn btn-primary flex-fill" onclick="copyURL()">📋 Copy URL</button>
                <button class="btn btn-success flex-fill" onclick="downloadQR()">💾 Save QR</button>
            </div>

            <button class="btn btn-danger w-100 mt-2" onclick="clearQR()">✗ Clear</button>
        </div>

    </div>

    <div class="card p-3">
        <h2>Active Share Sessions</h2>
        <button class="btn btn-primary mb-2" onclick="loadActiveSessions()">🔄 Refresh</button>
        <div id="sessionsContainer">
            <p class="text-center text-muted">Loading...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentStudent = null;
let shareURL = "";

// ✅ Search student locally
document.getElementById("searchForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const stateCode = document.getElementById("stateCodeInput").value.trim();

    const res = await fetch("/api/students");
    const students = await res.json();

    const student = students.find(s => s.state_code.toLowerCase() === stateCode.toLowerCase());
    if (!student) return alert("Student not found ❌");

    currentStudent = student;
    document.getElementById("studentName").textContent = student.full_name;
    document.getElementById("studentPhotos").textContent = student.photo_count;
    document.getElementById("studentInfo").style.display = "block";
});

// ✅ Create Share Link + QR Code
document.getElementById("generateForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentStudent) return alert("Search student first");

    const btn = document.getElementById("generateBtn");
    btn.disabled = true;
    btn.textContent = "⏳ Generating...";

    const formData = new FormData();
    formData.append("state_code", currentStudent.state_code);
    formData.append("expiry_hours", document.getElementById("expiryHours").value);
    formData.append("download_limit", document.getElementById("downloadLimit").value);

    const res = await fetch("/api/share/create", { method: "POST", body: formData });

    if (!res.ok) {
        alert("Failed to generate share link ❌");
        btn.disabled = false;
        btn.textContent = "📱 Generate QR Code";
        return;
    }

    const data = await res.json();

    shareURL = data.share_url;
    document.getElementById("qrImage").src = data.qr_code;
    document.getElementById("shareUrl").textContent = data.share_url;
    document.getElementById("qrResult").style.display = "block";

    btn.disabled = false;
    btn.textContent = "📱 Generate QR Code";

    loadSessions();
});

// ✅ Load Active Sessions
async function loadSessions() {
    const container = document.getElementById("sessionsContainer");
    container.innerHTML = `<p class="text-muted text-center">Loading...</p>`;

    const res = await fetch("/api/share/sessions");
    const data = await res.json();

    if (!data.sessions.length)
        return container.innerHTML = `<p class="text-center text-muted">No active sessions</p>`;

    container.innerHTML = data.sessions.map(s => `
        <div class="p-3 border rounded mb-2">
            <strong>${s.student_name}</strong><br>
            State Code: ${s.student_state_code}<br>
            Downloads: ${s.downloads_used}/${s.download_limit}<br>
            <button class="btn btn-sm btn-danger mt-2"
                onclick="deleteSession('${s.uuid}')">Delete</button>
        </div>
    `).join("");
}

// ✅ Delete a session
async function deleteSession(uuid) {
    await fetch(`/api/share/sessions/${uuid}`, { method: "DELETE" });
    loadSessions();
}

// ✅ Copy URL
function copyURL() {
    navigator.clipboard.writeText(shareURL);
    alert("URL Copied ✅");
}

// ✅ Download QR
function downloadQR() {
    const link = document.createElement("a");
    link.href = document.getElementById("qrImage").src;
    link.download = `QR_${currentStudent.state_code}.png`;
    link.click();
}

// ✅ Clear QR result
function clearQR() {
    document.getElementById("qrResult").style.display = "none";
    shareURL = "";
}

// Load on page start
loadSessions();
</script>

{% endblock %}
