{% extends "base.html" %}

{% block title %}Dashboard - TLP Photo App{% endblock %}

{% block extra_css %}
<style>
    .session-switcher {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .session-select {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .session-select label {
        font-weight: 600;
        color: #2C3E50;
        white-space: nowrap;
    }
    
    .session-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
    }
    
    .badge-active {
        background: #D5F4E6;
        color: #27AE60;
    }
    
    .badge-viewing {
        background: #D6EAF8;
        color: #2980B9;
    }
    
    .badge-closed {
        background: #F0F0F0;
        color: #7F8C8D;
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>üìä Dashboard</h1>
    <button class="btn btn-primary" onclick="showNewSessionModal()">+ New Session</button>
</div>

<!-- Session Switcher -->
<div class="session-switcher">
    <div class="session-select">
        <label>üìÇ Viewing Session:</label>
        <select id="sessionSelector" class="form-control" style="flex: 1; max-width: 400px;" onchange="switchViewingSession()">
            <option value="">-- Select Session --</option>
        </select>
        <button class="btn btn-primary" onclick="loadAllSessions()" style="padding: 10px 20px;">
            üîÑ Refresh
        </button>
    </div>
    
    <div id="sessionInfo" style="margin-top: 15px; display: none;">
        <p style="color: #7F8C8D; font-size: 14px; margin: 0;">
            <span id="sessionStatusBadge"></span>
            <span id="sessionDetails"></span>
        </p>
    </div>
</div>

{% if not session %}
<div class="card">
    <h2>No Active Session</h2>
    <p>Create a new session to start enrolling students and importing photos.</p>
    <button class="btn btn-success" onclick="showNewSessionModal()">Create Session</button>
</div>
{% else %}

<div class="stats-grid" id="statsContainer">
    <div class="stat-card blue">
        <h3 id="statStudents">{{ stats.students or 0 }}</h3>
        <p>Students Enrolled</p>
    </div>
    <div class="stat-card green">
        <h3 id="statPhotos">{{ stats.photos or 0 }}</h3>
        <p>Photos Processed</p>
    </div>
    <div class="stat-card purple">
        <h3 id="statFaces">{{ stats.total_faces or 0 }}</h3>
        <p>Faces Detected</p>
    </div>
    <div class="stat-card orange">
        <h3 id="statMatched">{{ stats.matched_faces or 0 }}</h3>
        <p>Faces Matched</p>
    </div>
</div>

<div class="card">
    <h2>Session Information</h2>
    <table id="sessionInfoTable">
        <tr>
            <td><strong>Name:</strong></td>
            <td id="infoName">{{ session.name }}</td>
        </tr>
        <tr>
            <td><strong>Location:</strong></td>
            <td id="infoLocation">{{ session.location or 'Not specified' }}</td>
        </tr>
        <tr>
            <td><strong>Started:</strong></td>
            <td id="infoStarted">{{ session.start_date.strftime('%Y-%m-%d %H:%M') }}</td>
        </tr>
        <tr>
            <td><strong>Status:</strong></td>
            <td id="infoStatus">
                {% if session.is_active %}
                    <span style="color: #2ECC71;">üü¢ Active</span>
                {% else %}
                    <span style="color: #E74C3C;">üî¥ Closed</span>
                {% endif %}
            </td>
        </tr>
    </table>
</div>

<div class="card">
    <h2>Quick Actions</h2>
    <div id="quickActionsNote" class="alert alert-info" style="display: none; margin-bottom: 15px;">
        ‚ö†Ô∏è <strong>Note:</strong> You're viewing a <strong>non-active session</strong>. 
        To enroll students or import photos, please activate this session first.
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <a href="/enroll" class="btn btn-primary">üë§ Enroll Students</a>
        <a href="/import" class="btn btn-primary">üì∑ Import Photos</a>
        <a href="/review" class="btn btn-primary">‚úì Review Matches</a>
        <a href="/share" class="btn btn-primary">üì± Generate QR Codes</a>
    </div>
</div>

{% endif %}

<div class="card">
    <h2>All Sessions</h2>
    <table id="sessionsTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Location</th>
                <th>Started</th>
                <th>Students</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Populated by JavaScript -->
        </tbody>
    </table>
</div>

<!-- Modal for New Session -->
<div id="newSessionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; margin: 0;">
        <h2>Create New Session</h2>
        <form id="newSessionForm" onsubmit="createSession(event)">
            <div class="form-group">
                <label>Session Name *</label>
                <input type="text" name="name" class="form-control" required placeholder="e.g., Summer Camp 2025">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" name="location" class="form-control" placeholder="e.g., Lagos">
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn btn-success">Create Session</button>
                <button type="button" class="btn btn-danger" onclick="hideNewSessionModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let currentViewingSessionId = {{ session.id if session else 'null' }};
    let currentActiveSessionId = {{ session.id if session and session.is_active else 'null' }};
    let allSessions = [];
    
    // Load all sessions on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadAllSessions();
    });
    
    async function loadAllSessions() {
        try {
            const response = await fetch('/api/sessions');
            allSessions = await response.json();
            
            // Populate dropdown
            const selector = document.getElementById('sessionSelector');
            selector.innerHTML = '<option value="">-- Select Session --</option>';
            
            allSessions.forEach(session => {
                const option = document.createElement('option');
                option.value = session.id;
                
                let label = session.name;
                if (session.is_active) {
                    label += ' ‚≠ê (Active)';
                }
                
                option.textContent = label;
                option.selected = session.id === currentViewingSessionId;
                
                selector.appendChild(option);
            });
            
            // Populate table
            updateSessionsTable();
            
            // Update session info if one is selected
            if (currentViewingSessionId) {
                updateSessionInfo();
            }
            
        } catch (error) {
            console.error('Failed to load sessions:', error);
            showMessage('Failed to load sessions', 'error');
        }
    }
    
    function updateSessionsTable() {
        const tbody = document.querySelector('#sessionsTable tbody');
        
        if (!allSessions.length) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #7F8C8D;">No sessions yet</td></tr>';
            return;
        }
        
        tbody.innerHTML = allSessions.map(s => `
            <tr ${s.id === currentViewingSessionId ? 'style="background: #E8F4FD;"' : ''}>
                <td>
                    <strong>${s.name}</strong>
                    ${s.id === currentViewingSessionId ? '<span class="badge-viewing session-badge">Viewing</span>' : ''}
                </td>
                <td>${s.location || '-'}</td>
                <td>${new Date(s.start_date).toLocaleDateString()}</td>
                <td>${s.student_count}</td>
                <td>
                    ${s.is_active 
                        ? '<span style="color: #2ECC71;">üü¢ Active</span>' 
                        : '<span style="color: #95A5A6;">‚ö´ Closed</span>'}
                </td>
                <td>
                    <button class="btn btn-primary" style="padding: 8px 16px; font-size: 12px; margin-right: 5px;" 
                        onclick="viewSession(${s.id})">
                        üëÅÔ∏è View
                    </button>
                    ${!s.is_active ? `
                        <button class="btn btn-success" style="padding: 8px 16px; font-size: 12px;" 
                            onclick="activateSession(${s.id})">
                            ‚≠ê Activate
                        </button>
                    ` : ''}
                </td>
            </tr>
        `).join('');
    }
    
    async function switchViewingSession() {
        const sessionId = document.getElementById('sessionSelector').value;
        
        if (!sessionId) {
            return;
        }
        
        await viewSession(parseInt(sessionId));
    }
    
    async function viewSession(sessionId) {
        try {
            const response = await fetch(`/api/sessions/${sessionId}/view`);
            const data = await response.json();
            
            if (data.success) {
                currentViewingSessionId = sessionId;
                
                // Update selector
                document.getElementById('sessionSelector').value = sessionId;
                
                // Update stats
                updateDashboardStats(data.stats);
                
                // Update session info
                updateSessionInfo();
                
                // Update table highlighting
                updateSessionsTable();
                
                // Show warning if viewing non-active session
                const session = allSessions.find(s => s.id === sessionId);
                if (session && !session.is_active) {
                    document.getElementById('quickActionsNote').style.display = 'block';
                } else {
                    document.getElementById('quickActionsNote').style.display = 'none';
                }
                
                showMessage(`Now viewing: ${data.session.name}`, 'success');
            }
        } catch (error) {
            console.error('Failed to switch session:', error);
            showMessage('Failed to switch session', 'error');
        }
    }
    
    function updateDashboardStats(stats) {
        document.getElementById('statStudents').textContent = stats.students || 0;
        document.getElementById('statPhotos').textContent = stats.photos || 0;
        document.getElementById('statFaces').textContent = stats.total_faces || 0;
        document.getElementById('statMatched').textContent = stats.matched_faces || 0;
    }
    
    function updateSessionInfo() {
        const session = allSessions.find(s => s.id === currentViewingSessionId);
        
        if (!session) return;
        
        // Update info section
        document.getElementById('sessionInfo').style.display = 'block';
        
        let badge = '';
        let details = '';
        
        if (session.is_active) {
            badge = '<span class="badge-active session-badge">ACTIVE - Operations Enabled</span>';
            details = 'You can enroll students and import photos in this session.';
        } else {
            badge = '<span class="badge-viewing session-badge">VIEWING ONLY</span>';
            details = 'To make changes, activate this session first.';
        }
        
        document.getElementById('sessionStatusBadge').innerHTML = badge;
        document.getElementById('sessionDetails').textContent = details;
        
        // Update table
        document.getElementById('infoName').textContent = session.name;
        document.getElementById('infoLocation').textContent = session.location || 'Not specified';
        document.getElementById('infoStarted').textContent = new Date(session.start_date).toLocaleString();
        document.getElementById('infoStatus').innerHTML = session.is_active 
            ? '<span style="color: #2ECC71;">üü¢ Active</span>'
            : '<span style="color: #E74C3C;">üî¥ Closed</span>';
    }
    
    async function activateSession(sessionId) {
        try {
            const response = await fetch(`/api/sessions/${sessionId}/activate`, {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage('Session activated', 'success');
                currentActiveSessionId = sessionId;
                setTimeout(() => window.location.reload(), 1000);
            }
        } catch (error) {
            showMessage('Failed to activate session', 'error');
        }
    }
    
    function showNewSessionModal() {
        document.getElementById('newSessionModal').style.display = 'flex';
    }
    
    function hideNewSessionModal() {
        document.getElementById('newSessionModal').style.display = 'none';
        document.getElementById('newSessionForm').reset();
    }
    
    async function createSession(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        try {
            const response = await fetch('/api/sessions', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage(data.message, 'success');
                hideNewSessionModal();
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showMessage(data.message, 'error');
            }
        } catch (error) {
            showMessage('Failed to create session', 'error');
        }
    }
</script>
{% endblock %}