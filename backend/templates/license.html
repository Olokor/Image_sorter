{% extends "base.html" %}

{% block title %}License - TLP Photo App{% endblock %}

{% block content %}
<div class="header">
    <h1>üí≥ License & Payment</h1>
</div>

<!-- License Status Card -->
<div class="card">
    <h2>License Status</h2>
    <table style="width: 100%; max-width: 600px;">
        <tr>
            <td><strong>Status:</strong></td>
            <td>
                {% if license.valid %}
                    <span style="color: #2ECC71; font-weight: 600;">‚úì Active</span>
                {% else %}
                    <span style="color: #E74C3C; font-weight: 600;">‚úó {{ license.message or 'Expired' }}</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td><strong>Photographer:</strong></td>
            <td>{{ photographer.name }} ({{ photographer.email }})</td>
        </tr>
        <tr>
            <td><strong>Valid Until:</strong></td>
            <td>{{ license.expires }}</td>
        </tr>
        <tr>
            <td><strong>Days Remaining:</strong></td>
            <td>
                <span style="
                    {% if license.days_remaining < 7 %}color: #E74C3C;
                    {% elif license.days_remaining < 14 %}color: #F39C12;
                    {% else %}color: #2ECC71;{% endif %}
                    font-weight: 600;">
                    {{ license.days_remaining }} days
                </span>
            </td>
        </tr>
    </table>
    
    {% if not license.valid or license.days_remaining < 7 %}
    <div class="alert alert-warning" style="margin-top: 20px;">
        <strong>‚ö† Action Required:</strong> 
        {% if not license.valid %}
            Your license has expired. Please renew to continue using the app.
        {% else %}
            Your license expires in {{ license.days_remaining }} days. Renew now to avoid interruption.
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Payment Section -->
<div class="card">
    <h2>Pay for Students</h2>
    
    <div style="background: #ECF0F1; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin-top: 0; color: #2C3E50;">üí∞ Pricing</h3>
        <div style="font-size: 18px; color: #34495E;">
            <strong>‚Ç¶200</strong> per student enrolled
        </div>
        <ul style="margin-top: 15px; color: #7F8C8D; line-height: 1.8;">
            <li>30 days validity per payment</li>
            <li>Unlimited photo uploads</li>
            <li>Face recognition & sorting</li>
            <li>QR code sharing for students</li>
        </ul>
    </div>
    
    {% if session %}
    <div style="background: #E8F5E9; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #4CAF50;">
        <strong>Current Session:</strong> {{ session.name }}<br>
        <strong>Students Enrolled:</strong> {{ session.student_count }}<br>
        <strong>Amount to Pay:</strong> ‚Ç¶{{ session.student_count * 200 }}
    </div>
    
    <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
            Number of students to pay for:
        </label>
        <input 
            type="number" 
            id="studentCountInput" 
            value="{{ session.student_count }}"
            min="1"
            style="width: 100%; padding: 12px; border: 2px solid #BDC3C7; border-radius: 6px; font-size: 16px;"
            onchange="updatePaymentAmount()"
        >
        <div id="paymentAmount" style="margin-top: 10px; font-size: 18px; font-weight: 600; color: #E67E22;">
            Amount: ‚Ç¶{{ session.student_count * 200 }}
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning">
        <strong>‚ö†Ô∏è No Active Session</strong><br>
        Please create a session first before making payment.
    </div>
    {% endif %}
    
    <button 
        class="btn btn-primary" 
        style="width: 100%; height: 60px; font-size: 18px;"
        onclick="initializePayment()"
        {% if not session %}disabled{% endif %}
    >
        üõí Pay Now
    </button>
    
    <div id="paymentStatus" style="margin-top: 20px; display: none;"></div>
</div>

<!-- Update License Section -->
<div class="card">
    <h2>Update License</h2>
    <p style="color: #7F8C8D; margin-bottom: 20px;">
        After completing payment, click the button below to activate your license.
    </p>
    
    <button 
        class="btn btn-success" 
        style="width: 100%; height: 60px; font-size: 18px;"
        onclick="updateLicense()"
    >
        üîÑ Update License from Server
    </button>
    
    <div id="updateStatus" style="margin-top: 20px; display: none;"></div>
</div>

{% if session %}
<!-- Session Billing (if needed) -->
<div class="card">
    <h2>Current Session Billing</h2>
    <table style="width: 100%; max-width: 600px;">
        <tr>
            <td><strong>Session:</strong></td>
            <td>{{ session.name }}</td>
        </tr>
        <tr>
            <td><strong>Students Enrolled:</strong></td>
            <td>{{ session.student_count }}</td>
        </tr>
        <tr>
            <td><strong>Amount Due:</strong></td>
            <td>
                {% if session.is_free_trial %}
                    <span style="color: #2ECC71; font-weight: 600;">‚Ç¶0.00 (Free Trial)</span>
                {% else %}
                    <span style="color: #E67E22; font-weight: 600;">
                        ‚Ç¶{{ (session.student_count * 200)|round(2) }}
                    </span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <td><strong>Payment Status:</strong></td>
            <td>
                {% if session.payment_verified %}
                    <span style="color: #2ECC71; font-weight: 600;">‚úì Paid</span>
                {% elif session.is_free_trial %}
                    <span style="color: #3498DB;">Free Trial</span>
                {% else %}
                    <span style="color: #F39C12; font-weight: 600;">‚ö† Pending Payment</span>
                {% endif %}
            </td>
        </tr>
    </table>
</div>
{% endif %}

<!-- Device Info (for troubleshooting) -->
<div class="card" style="margin-top: 20px;">
    <details>
        <summary style="cursor: pointer; color: #3498DB; font-weight: 600;">
            üîß Device Information (for support)
        </summary>
        <div id="deviceInfo" style="margin-top: 15px; font-family: monospace; font-size: 12px; color: #7F8C8D;">
            Loading...
        </div>
    </details>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentPaymentReference = null;

// Load device info on page load
window.addEventListener('DOMContentLoaded', function() {
    loadDeviceInfo();
});

async function loadDeviceInfo() {
    try {
        const response = await fetch('/api/license/device-info');
        const data = await response.json();
        
        document.getElementById('deviceInfo').innerHTML = `
            <strong>Device Fingerprint:</strong> ${data.device_fingerprint}<br>
            <strong>System:</strong> ${data.system}<br>
            <strong>Machine:</strong> ${data.machine}<br>
            <strong>Hostname:</strong> ${data.hostname}
        `;
    } catch (error) {
        document.getElementById('deviceInfo').innerHTML = 'Error loading device info';
    }
}

async function initializePayment() {
    const statusDiv = document.getElementById('paymentStatus');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div style="color: #3498DB;">üîÑ Initializing payment...</div>';
    
    try {
        const response = await fetch('/api/license/initialize-payment', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentPaymentReference = data.reference;
            
            statusDiv.innerHTML = `
                <div style="background: #E8F5E9; padding: 15px; border-radius: 6px; border-left: 4px solid #4CAF50;">
                    <strong>‚úì Payment initialized</strong><br>
                    <span style="font-size: 12px; color: #666;">Reference: ${data.reference}</span><br><br>
                    <button class="btn btn-success" onclick="openPaymentPage('${data.payment_url}')">
                        üåê Open Payment Page
                    </button>
                    <button class="btn btn-secondary" onclick="verifyPayment()" style="margin-left: 10px;">
                        üîç I've Paid - Check Status
                    </button>
                </div>
            `;
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <strong>‚ùå Error:</strong> ${data.error}
                </div>
            `;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <strong>‚ùå Network Error:</strong> ${error.message}<br>
                <small>Please check your internet connection and try again.</small>
            </div>
        `;
    }
}

function openPaymentPage(paymentUrl) {
    window.open(paymentUrl, '_blank');
    
    const statusDiv = document.getElementById('paymentStatus');
    statusDiv.innerHTML += `
        <div style="margin-top: 15px; background: #FFF3CD; padding: 15px; border-radius: 6px; border-left: 4px solid #FFC107;">
            <strong>‚è≥ Complete payment in the new window</strong><br>
            After payment, return here and click "I've Paid - Check Status"
        </div>
    `;
}

async function verifyPayment() {
    if (!currentPaymentReference) {
        alert('No payment reference found. Please initialize payment first.');
        return;
    }
    
    const statusDiv = document.getElementById('paymentStatus');
    statusDiv.innerHTML = '<div style="color: #3498DB;">üîÑ Verifying payment...</div>';
    
    try {
        const formData = new FormData();
        formData.append('reference', currentPaymentReference);
        
        const response = await fetch('/api/license/verify-payment', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            statusDiv.innerHTML = `
                <div style="background: #E8F5E9; padding: 20px; border-radius: 6px; border-left: 4px solid #4CAF50;">
                    <h3 style="margin-top: 0; color: #4CAF50;">‚úì Payment Successful!</h3>
                    <p>Your license key has been sent to: <strong>${data.email}</strong></p>
                    <p style="color: #666;">Check your email and paste the license key above to activate.</p>
                </div>
            `;
            
            // Scroll to activation section
            document.getElementById('licenseKeyInput').scrollIntoView({ behavior: 'smooth' });
        } else {
            statusDiv.innerHTML = `
                <div style="background: #FFF3CD; padding: 15px; border-radius: 6px; border-left: 4px solid #FFC107;">
                    <strong>‚è≥ Payment Pending</strong><br>
                    ${data.error || 'Please complete the payment and try again.'}
                    <br><br>
                    <button class="btn btn-primary" onclick="verifyPayment()">
                        üîÑ Check Again
                    </button>
                </div>
            `;
        }
    } catch (error) {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <strong>‚ùå Verification Error:</strong> ${error.message}
            </div>
        `;
    }
}

async function activateLicense() {
    const licenseKey = document.getElementById('licenseKeyInput').value.trim();
    
    if (!licenseKey) {
        alert('Please enter a license key');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('license_key', licenseKey);
        
        const response = await fetch('/api/license/activate', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úì ' + data.message);
            window.location.reload();
        } else {
            alert('‚ùå Activation failed: ' + data.error);
        }
    } catch (error) {
        alert('‚ùå Error: ' + error.message);
    }
}
</script>
{% endblock %}