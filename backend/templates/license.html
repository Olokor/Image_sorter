{% extends "base.html" %}

{% block title %}License & Payment - Photo Sorter{% endblock %}

{% block extra_css %}
<style>
    .pricing-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 30px;
    }
    
    .pricing-card h2 {
        font-size: 48px;
        margin-bottom: 10px;
    }
    
    .pricing-card p {
        font-size: 18px;
        opacity: 0.9;
    }
    
    .feature-list {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    
    .feature-list ul {
        list-style: none;
        padding: 0;
    }
    
    .feature-list li {
        padding: 12px 0;
        border-bottom: 1px solid #F0F0F0;
        color: #2C3E50;
        font-size: 16px;
    }
    
    .feature-list li:last-child {
        border-bottom: none;
    }
    
    .feature-list li:before {
        content: "‚úì";
        color: #2ECC71;
        font-weight: bold;
        margin-right: 10px;
        font-size: 18px;
    }
    
    .student-count-selector {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    
    .count-buttons {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }
    
    .count-btn {
        width: 50px;
        height: 50px;
        border: 2px solid #3498DB;
        background: white;
        color: #3498DB;
        font-size: 24px;
        font-weight: bold;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .count-btn:hover {
        background: #3498DB;
        color: white;
    }
    
    .count-display {
        font-size: 48px;
        font-weight: bold;
        color: #2C3E50;
        min-width: 100px;
        text-align: center;
    }
    
    .amount-display {
        background: #F8F9FA;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        margin-top: 20px;
    }
    
    .amount-display .amount {
        font-size: 36px;
        font-weight: bold;
        color: #E67E22;
    }
    
    .license-status {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    
    .status-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }
    
    .status-active {
        background: #D5F4E6;
        color: #27AE60;
    }
    
    .status-expired {
        background: #FADBD8;
        color: #C0392B;
    }
    
    .payment-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }
    
    .payment-modal.active {
        display: flex;
    }
    
    .modal-content {
        background: white;
        padding: 40px;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        text-align: center;
    }
</style>
<script src="https://js.paystack.co/v2/inline.js"></script>
{% endblock %}

{% block content %}
<div class="header">
    <h1>üí≥ License & Payment</h1>
</div>

<!-- Current License Status -->
<div class="license-status">
    <h2>Current License Status</h2>
    <div style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <span><strong>Status:</strong></span>
            <span class="status-badge {% if license.valid %}status-active{% else %}status-expired{% endif %}">
                {% if license.valid %}‚úì Active{% else %}‚úó Expired{% endif %}
            </span>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <span><strong>Students Available:</strong></span>
            <span style="font-size: 24px; font-weight: bold; color: #3498DB;">
                {{ license.students_available or 0 }}
            </span>
        </div>
        
        {% if license.expires %}
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <span><strong>Valid Until:</strong></span>
            <span>{{ license.expires }}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between;">
            <span><strong>Days Remaining:</strong></span>
            <span style="
                {% if license.days_remaining < 7 %}color: #E74C3C;
                {% elif license.days_remaining < 14 %}color: #F39C12;
                {% else %}color: #2ECC71;{% endif %}
                font-weight: 600;">
                {{ license.days_remaining }} days
            </span>
        </div>
        {% endif %}
    </div>
    
    <button class="btn btn-primary" style="margin-top: 20px; width: 100%;" onclick="updateLicenseFromServer()">
        üîÑ Update License from Server
    </button>
</div>

<!-- Pricing -->
<div class="pricing-card">
    <h2>‚Ç¶200</h2>
    <p>Per Student ‚Ä¢ 30 Days Validity</p>
</div>

<!-- Features -->
<div class="feature-list">
    <h3 style="margin-bottom: 20px; color: #2C3E50;">What You Get:</h3>
    <ul>
        <li>Unlimited photo uploads and processing</li>
        <li>Advanced AI face recognition & matching</li>
        <li>Automatic photo sorting by student</li>
        <li>QR code generation for easy sharing</li>
        <li>Secure student gallery access</li>
        <li>Download tracking and management</li>
        <li>30 days of full access per payment</li>
    </ul>
</div>

<!-- Purchase License -->
<div class="student-count-selector">
    <h2 style="text-align: center; margin-bottom: 30px;">Purchase License</h2>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <label style="font-size: 18px; color: #34495E; font-weight: 600;">
            Number of Students
        </label>
    </div>
    
    <div class="count-buttons">
        <button class="count-btn" onclick="decrementCount()">‚àí</button>
        <div class="count-display" id="studentCount">10</div>
        <button class="count-btn" onclick="incrementCount()">+</button>
    </div>
    
    <div class="amount-display">
        <div style="color: #7F8C8D; margin-bottom: 5px;">Total Amount</div>
        <div class="amount" id="totalAmount">‚Ç¶2,000</div>
        <div style="color: #7F8C8D; font-size: 14px; margin-top: 5px;">
            Valid for 30 days
        </div>
    </div>
    
    <button class="btn btn-success" style="width: 100%; height: 60px; font-size: 18px; margin-top: 30px;" onclick="initializePayment()">
        üõí Proceed to Payment
    </button>
</div>

<!-- Important Notes -->
<div class="card">
    <h3 style="color: #E67E22; margin-bottom: 15px;">‚ö†Ô∏è Important:</h3>
    <ul style="line-height: 2; color: #34495E;">
        <li>Payment is processed securely via Paystack</li>
        <li>License is activated immediately after successful payment</li>
        <li>You'll receive a confirmation email with details</li>
        <li>Click "Update License from Server" after payment to activate</li>
        <li>You cannot create new sessions without an active license</li>
        <li>You can only enroll students up to your purchased limit</li>
    </ul>
</div>

<!-- Payment Modal (for showing Paystack) -->
<div id="paymentModal" class="payment-modal">
    <div class="modal-content">
        <div class="spinner" style="margin: 0 auto 20px;"></div>
        <h3>Initializing Payment...</h3>
        <p style="color: #7F8C8D; margin-top: 10px;">Please wait</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let studentCount = 10;
const pricePerStudent = 200;
let currentPaymentReference = null;

function updateDisplay() {
    document.getElementById('studentCount').textContent = studentCount;
    const total = studentCount * pricePerStudent;
    document.getElementById('totalAmount').textContent = `‚Ç¶${total.toLocaleString()}`;
}

function incrementCount() {
    studentCount += 1;
    updateDisplay();
}

function decrementCount() {
    if (studentCount > 1) {
        studentCount -= 1;
        updateDisplay();
    }
}

async function initializePayment() {
    // Show modal
    document.getElementById('paymentModal').classList.add('active');
    
    try {
        const response = await fetch('/api/license/purchase/initialize', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                student_count: studentCount
            })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Payment initialization failed');
        }
        
        currentPaymentReference = data.reference;
        
        // Hide modal
        document.getElementById('paymentModal').classList.remove('active');
        
        // Initialize Paystack popup
        const handler = PaystackPop.setup({
            key: data.public_key,
            email: '{{ photographer.email }}',
            amount: data.amount * 100, // Convert to kobo
            currency: 'NGN',
            ref: data.reference,
            metadata: {
                custom_fields: [
                    {
                        display_name: "Student Count",
                        variable_name: "student_count",
                        value: studentCount
                    },
                    {
                        display_name: "Photographer",
                        variable_name: "photographer_name",
                        value: '{{ photographer.name }}'
                    }
                ]
            },
            callback: function(response) {
                showMessage('Payment successful! Verifying...', 'success');
                verifyPayment(response.reference);
            },
            onClose: function() {
                showMessage('Payment cancelled', 'info');
            }
        });
        
        handler.openIframe();
        
    } catch (error) {
        document.getElementById('paymentModal').classList.remove('active');
        showMessage('Error: ' + error.message, 'error');
    }
}

async function verifyPayment(reference) {
    try {
        const response = await fetch(`/api/license/verify-payment/${reference}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('‚úì Payment verified! License activated. Refreshing...', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showMessage('Payment verification pending. Please click "Update License from Server" in a moment.', 'info');
        }
    } catch (error) {
        showMessage('Verification in progress. Click "Update License from Server" to check status.', 'info');
    }
}

async function updateLicenseFromServer() {
    try {
        const response = await fetch('/api/license/update-from-server', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage('‚úì ' + data.message, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showMessage(data.message || 'No updates available', 'info');
        }
    } catch (error) {
        showMessage('Connection error. Please check your internet connection.', 'error');
    }
}

// Initialize display
updateDisplay();
</script>
{% endblock %}