{% extends "base.html" %}

{% block title %}License & Payment - Photo Sorter{% endblock %}

{% block extra_css %}
<style>
    .pricing-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 16px;
        text-align: center;
        margin-bottom: 30px;
        position: relative;
    }
    
    .pricing-card .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 16px;
    }
    
    .pricing-card h2 {
        font-size: 48px;
        margin-bottom: 10px;
    }
    
    .pricing-card p {
        font-size: 18px;
        opacity: 0.9;
    }
    
    .pricing-note {
        background: #E8F4FD;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
        color: #2980B9;
        font-size: 14px;
    }
    
    .feature-list {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    
    .feature-list ul {
        list-style: none;
        padding: 0;
    }
    
    .feature-list li {
        padding: 12px 0;
        border-bottom: 1px solid #F0F0F0;
        color: #2C3E50;
        font-size: 16px;
    }
    
    .feature-list li:last-child {
        border-bottom: none;
    }
    
    .feature-list li:before {
        content: "‚úì";
        color: #2ECC71;
        font-weight: bold;
        margin-right: 10px;
        font-size: 18px;
    }
    
    .student-count-selector {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    
    .count-buttons {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }
    
    .count-btn {
        width: 50px;
        height: 50px;
        border: 2px solid #3498DB;
        background: white;
        color: #3498DB;
        font-size: 24px;
        font-weight: bold;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .count-btn:hover {
        background: #3498DB;
        color: white;
    }
    
    .count-display {
        font-size: 48px;
        font-weight: bold;
        color: #2C3E50;
        min-width: 100px;
        text-align: center;
    }
    
    .amount-display {
        background: #F8F9FA;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        margin-top: 20px;
    }
    
    .amount-display .amount {
        font-size: 36px;
        font-weight: bold;
        color: #E67E22;
    }
    
    .license-status {
        background: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }
    
    .status-badge {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
    }
    
    .status-active {
        background: #D5F4E6;
        color: #27AE60;
    }
    
    .status-expired {
        background: #FADBD8;
        color: #C0392B;
    }
    
    .payment-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }
    
    .payment-modal.active {
        display: flex;
    }
    
    .modal-content {
        background: white;
        padding: 40px;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        text-align: center;
    }
    
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498DB;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
<script src="https://js.paystack.co/v2/inline.js"></script>
{% endblock %}

{% block content %}
<div class="header">
    <h1>üí≥ License & Payment</h1>
</div>

<!-- Current License Status -->
<div class="license-status">
    <h2>Current License Status</h2>
    <div style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <span><strong>Status:</strong></span>
            <span class="status-badge {% if license.valid %}status-active{% else %}status-expired{% endif %}">
                {% if license.valid %}‚úì Active{% else %}‚úó Expired{% endif %}
            </span>
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <span><strong>Students Available:</strong></span>
            <span style="font-size: 24px; font-weight: bold; color: #3498DB;">
                {{ license.students_available or 0 }}
            </span>
        </div>
        
        {% if license.expires %}
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <span><strong>Valid Until:</strong></span>
            <span>{{ license.expires }}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between;">
            <span><strong>Days Remaining:</strong></span>
            <span style="
                {% if license.days_remaining < 7 %}color: #E74C3C;
                {% elif license.days_remaining < 14 %}color: #F39C12;
                {% else %}color: #2ECC71;{% endif %}
                font-weight: 600;">
                {{ license.days_remaining }} days
            </span>
        </div>
        {% endif %}
    </div>
    
    <button class="btn btn-primary" style="margin-top: 20px; width: 100%;" onclick="updateLicenseFromServer()">
        üîÑ Update License from Server
    </button>
</div>

<!-- Pricing -->
<div class="pricing-card" id="pricingCard">
    <div class="loading-overlay" id="pricingLoader">
        <div class="spinner"></div>
    </div>
    <h2 id="priceDisplay">‚Ç¶---</h2>
    <p>Per Student ‚Ä¢ 30 Days Validity</p>
    <div class="pricing-note" id="pricingNote" style="display: none;">
        üí° Pricing loaded from server
    </div>
</div>

<!-- Features -->
<div class="feature-list">
    <h3 style="margin-bottom: 20px; color: #2C3E50;">What You Get:</h3>
    <ul>
        <li>Unlimited photo uploads and processing</li>
        <li>Advanced AI face recognition & matching</li>
        <li>Automatic photo sorting by student</li>
        <li>QR code generation for easy sharing</li>
        <li>Secure student gallery access</li>
        <li>Download tracking and management</li>
        <li>30 days of full access per payment</li>
    </ul>
</div>

<!-- Purchase License -->
<div class="student-count-selector">
    <h2 style="text-align: center; margin-bottom: 30px;">Purchase License</h2>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <label style="font-size: 18px; color: #34495E; font-weight: 600;">
            Number of Students
        </label>
    </div>
    
    <div class="count-buttons">
        <button class="count-btn" onclick="decrementCount()">‚àí</button>
        <div class="count-display" id="studentCount">10</div>
        <button class="count-btn" onclick="incrementCount()">+</button>
    </div>
    
    <div class="amount-display">
        <div style="color: #7F8C8D; margin-bottom: 5px;">Total Amount</div>
        <div class="amount" id="totalAmount">‚Ç¶---</div>
        <div style="color: #7F8C8D; font-size: 14px; margin-top: 5px;">
            Valid for 30 days
        </div>
    </div>
    
    <button class="btn btn-success" style="width: 100%; height: 60px; font-size: 18px; margin-top: 30px;" onclick="initializePayment()" id="purchaseBtn" disabled>
        üõí Proceed to Payment
    </button>
</div>

<!-- Important Notes -->
<div class="card">
    <h3 style="color: #E67E22; margin-bottom: 15px;">‚ö†Ô∏è Important:</h3>
    <ul style="line-height: 2; color: #34495E;">
        <li>Payment is processed securely via Paystack</li>
        <li>License is activated immediately after successful payment</li>
        <li>You'll receive a confirmation email with details</li>
        <li>Click "Update License from Server" after payment to activate</li>
        <li>You cannot create new sessions without an active license</li>
        <li>You can only enroll students up to your purchased limit</li>
    </ul>
</div>

<!-- Payment Modal (for showing Paystack) -->
<div id="paymentModal" class="payment-modal">
    <div class="modal-content">
        <div class="spinner" style="margin: 0 auto 20px;"></div>
        <h3>Initializing Payment...</h3>
        <p style="color: #7F8C8D; margin-top: 10px;">Please wait</p>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// JavaScript for license.html with dynamic pricing
let studentCount = 10;
let pricePerStudent = null; // Will be loaded from server
let currentPaymentReference = null;

// Load pricing from server on page load
async function loadPricingFromServer() {
    console.log('üîÑ Loading pricing from server...');
    
    try {
        // Use the existing auth_service JWT token
        const response = await fetch('/api/license/pricing');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.price_per_student) {
            pricePerStudent = data.price_per_student;
            
            // Update display
            document.getElementById('priceDisplay').textContent = `‚Ç¶${pricePerStudent.toLocaleString()}`;
            document.getElementById('pricingNote').style.display = 'block';
            document.getElementById('pricingLoader').style.display = 'none';
            document.getElementById('purchaseBtn').disabled = false;
            
            // Update amount display
            updateDisplay();
            
            console.log(`‚úì Pricing loaded: ‚Ç¶${pricePerStudent} per student`);
        } else {
            throw new Error('Invalid pricing data');
        }
        
    } catch (error) {
        console.error('‚ùå Failed to load pricing:', error);
        
        // Fallback to default (should rarely happen)
        pricePerStudent = 200;
        document.getElementById('priceDisplay').textContent = `‚Ç¶${pricePerStudent} (Default)`;
        document.getElementById('pricingLoader').style.display = 'none';
        document.getElementById('purchaseBtn').disabled = false;
        updateDisplay();
        
        // Show warning
        const pricingCard = document.getElementById('pricingCard');
        const warning = document.createElement('div');
        warning.className = 'pricing-note';
        warning.style.background = '#FADBD8';
        warning.style.color = '#C0392B';
        warning.textContent = '‚ö†Ô∏è Could not load current pricing. Using default.';
        pricingCard.appendChild(warning);
    }
}

function updateDisplay() {
    if (pricePerStudent === null) return;
    
    document.getElementById('studentCount').textContent = studentCount;
    const total = studentCount * pricePerStudent;
    document.getElementById('totalAmount').textContent = `‚Ç¶${total.toLocaleString()}`;
}

function incrementCount() {
    studentCount += 1;
    updateDisplay();
}

function decrementCount() {
    if (studentCount > 1) {
        studentCount -= 1;
        updateDisplay();
    }
}

async function initializePayment() {
    if (pricePerStudent === null) {
        alert('‚ö†Ô∏è Pricing not loaded yet. Please wait...');
        return;
    }
    
    // Show modal
    document.getElementById('paymentModal').classList.add('active');
    
    try {
        // Create FormData
        const formData = new FormData();
        formData.append('student_count', studentCount);
        
        console.log('üîÑ Initializing payment for', studentCount, 'students...');
        
        // Call local backend API (which will forward to hosted backend with JWT)
        const response = await fetch('/api/license/purchase/initialize', {
            method: 'POST',
            body: formData
        });
        
        console.log('üì• Response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Response error:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('üì¶ Response data:', data);
        
        if (!data.success) {
            throw new Error(data.error || 'Payment initialization failed');
        }
        
        currentPaymentReference = data.reference;
        
        // Hide modal
        document.getElementById('paymentModal').classList.remove('active');
        
        console.log('‚úì Payment initialized:', data.reference);
        console.log('üí≥ Opening Paystack with key:', data.public_key);
        
        // Initialize Paystack popup
        const handler = PaystackPop.setup({
            key: data.public_key,
            email: '{{ photographer.email }}',
            amount: data.amount * 100, // Convert to kobo
            currency: 'NGN',
            ref: data.reference,
            metadata: {
                custom_fields: [
                    {
                        display_name: "Student Count",
                        variable_name: "student_count",
                        value: studentCount
                    },
                    {
                        display_name: "Photographer",
                        variable_name: "photographer_name",
                        value: '{{ photographer.name }}'
                    },
                    {
                        display_name: "Price Per Student",
                        variable_name: "price_per_student",
                        value: pricePerStudent
                    }
                ]
            },
            callback: function(response) {
                console.log('‚úì Paystack payment successful:', response.reference);
                showMessage('Payment successful! Verifying...', 'success');
                verifyPayment(response.reference);
            },
            onClose: function() {
                console.log('‚ö† Paystack popup closed');
                showMessage('Payment cancelled', 'info');
            }
        });
        
        handler.openIframe();
        
    } catch (error) {
        console.error('‚ùå Payment initialization error:', error);
        document.getElementById('paymentModal').classList.remove('active');
        showMessage('Error: ' + error.message, 'error');
    }
}

async function verifyPayment(reference) {
    try {
        console.log('üîÑ Verifying payment:', reference);
        
        const response = await fetch(`/api/license/verify-payment/${reference}`, {
            method: 'POST'
        });
        
        console.log('üì• Verification response status:', response.status);
        
        const data = await response.json();
        console.log('üì¶ Verification data:', data);
        
        if (data.success) {
            showMessage('‚úì Payment verified! License activated. Refreshing...', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showMessage('Payment verification pending. Please click "Update License from Server" in a moment.', 'info');
        }
    } catch (error) {
        console.error('‚ùå Verification error:', error);
        showMessage('Verification in progress. Click "Update License from Server" to check status.', 'info');
    }
}

async function updateLicenseFromServer() {
    try {
        console.log('üîÑ Updating license from server...');
        
        const response = await fetch('/api/license/update-from-server', {
            method: 'POST'
        });
        
        console.log('üì• Update response status:', response.status);
        
        const data = await response.json();
        console.log('üì¶ Update data:', data);
        
        if (data.success) {
            showMessage('‚úì ' + data.message, 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showMessage(data.message || 'No updates available', 'info');
        }
    } catch (error) {
        console.error('‚ùå Update error:', error);
        showMessage('Connection error. Please check your internet connection.', 'error');
    }
}

function showMessage(message, type) {
    // Create a simple alert message
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '10000';
    alertDiv.style.minWidth = '300px';
    alertDiv.style.padding = '15px 20px';
    alertDiv.style.borderRadius = '8px';
    alertDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Load pricing when page loads
console.log('üìÑ License page loaded');
loadPricingFromServer();
</script>
{% endblock %}