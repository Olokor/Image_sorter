{% extends "base.html" %}

{% block title %}Enroll Students - TLP Photo App{% endblock %}

{% block extra_css %}
<style>
    .photo-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .photo-preview {
        position: relative;
        border: 2px solid #E8E8E8;
        border-radius: 8px;
        overflow: hidden;
        aspect-ratio: 1;
    }
    
    .photo-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .photo-preview .remove-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #E74C3C;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .photo-count {
        font-size: 14px;
        color: #7F8C8D;
        margin-top: 10px;
    }
    
    .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }
    
    @media (max-width: 768px) {
        .two-column {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>üë§ Enroll Students</h1>
</div>

{% if not session %}
<div class="alert alert-info">
    ‚ö† No active session. Please create or select a session first.
</div>
{% else %}

<div class="two-column">
    <div class="card">
        <h2>Enroll New Student</h2>
        <div class="alert alert-info" style="font-size: 13px;">
            üí° <strong>Tip:</strong> Upload 2-5 clear photos of the student for best face recognition accuracy.
        </div>
        
        <form id="enrollForm" onsubmit="enrollStudent(event)">
            <div class="form-group">
                <label>State Code *</label>
                <input type="text" name="state_code" class="form-control" required placeholder="e.g., LAG001">
            </div>
            
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" name="full_name" class="form-control" required placeholder="Full name">
            </div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" class="form-control" placeholder="student@example.com">
            </div>
            
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" name="phone" class="form-control" placeholder="+234...">
            </div>
            
            <div class="form-group">
                <label>Reference Photos (1-5 photos) *</label>
                <input type="file" id="photoInput" multiple accept="image/*" class="form-control" style="padding: 10px;" required>
                <div class="photo-count" id="photoCount">0/5 photos selected</div>
                <div id="photoPreview" class="photo-preview-grid"></div>
            </div>
            
            <button type="submit" class="btn btn-success" id="enrollBtn">
                ‚úì Enroll Student
            </button>
        </form>
    </div>
    
    <div class="card">
        <h2>Enrolled Students ({{ students|length }})</h2>
        
        <div style="margin-bottom: 15px;">
            <input type="text" id="searchInput" class="form-control" placeholder="üîç Search by name or state code..." onkeyup="filterStudents()">
        </div>
        
        {% if students %}
<div style="max-height: 600px; overflow-y: auto;">
    <table id="studentsTable">
        <thead>
            <tr>
                <th>State Code</th>
                <th>Name</th>
                <th>Enrollment</th>
                <th>Gallery</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td><strong>{{ student.state_code }}</strong></td>
                <td>{{ student.full_name }}</td>
                <td>
                    {% set ref_count = student.reference_photo_path.split(',')|length if student.reference_photo_path else 0 %}
                    <span title="Enrollment photos">üìù {{ ref_count }}</span>
                </td>
                <td>
                    <span title="Gallery photos (matched)">üì∑ <span class="gallery-photo-count" data-student-id="{{ student.id }}">...</span></span>
                </td>
                <td>
                    <button class="btn btn-danger" style="padding: 6px 12px; font-size: 12px;" onclick="deleteStudent({{ student.id }}, '{{ student.full_name }}')">
                        üóë Delete
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// Load actual gallery photo counts for each student
async function loadGalleryPhotoCounts() {
    try {
        const response = await fetch('/api/students');
        const students = await response.json();
        
        students.forEach(student => {
            const countElement = document.querySelector(`[data-student-id="${student.id}"]`);
            if (countElement) {
                countElement.textContent = student.photo_count || 0;
                
                // Color code based on count
                if (student.photo_count > 0) {
                    countElement.style.color = '#2ECC71';
                    countElement.style.fontWeight = 'bold';
                } else {
                    countElement.style.color = '#E74C3C';
                }
            }
        });
    } catch (error) {
        console.error('Failed to load photo counts:', error);
    }
}

// Load counts when page loads
if (document.getElementById('studentsTable')) {
    loadGalleryPhotoCounts();
}
</script>
{% else %}
<p style="text-align: center; color: #7F8C8D; padding: 40px;">No students enrolled yet</p>
{% endif %}
    </div>
</div>

{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    let selectedPhotos = [];
    const maxPhotos = 5;
    
    document.getElementById('photoInput')?.addEventListener('change', function(e) {
        const files = Array.from(e.target.files);
        
        if (selectedPhotos.length + files.length > maxPhotos) {
            showMessage(`Maximum ${maxPhotos} photos allowed`, 'error');
            return;
        }
        
        files.forEach(file => {
            if (selectedPhotos.length < maxPhotos) {
                selectedPhotos.push(file);
                addPhotoPreview(file);
            }
        });
        
        updatePhotoCount();
        e.target.value = ''; // Reset input
    });
    
    function addPhotoPreview(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('photoPreview');
            const div = document.createElement('div');
            div.className = 'photo-preview';
            div.dataset.filename = file.name;
            
            div.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <button type="button" class="remove-btn" onclick="removePhoto('${file.name}')">√ó</button>
            `;
            
            preview.appendChild(div);
        };
        reader.readAsDataURL(file);
    }
    
    function removePhoto(filename) {
        selectedPhotos = selectedPhotos.filter(f => f.name !== filename);
        
        const preview = document.querySelector(`[data-filename="${filename}"]`);
        if (preview) {
            preview.remove();
        }
        
        updatePhotoCount();
    }
    
    function updatePhotoCount() {
        const count = document.getElementById('photoCount');
        count.textContent = `${selectedPhotos.length}/${maxPhotos} photos selected`;
        
        if (selectedPhotos.length === 0) {
            count.style.color = '#E74C3C';
        } else if (selectedPhotos.length < 2) {
            count.style.color = '#F39C12';
        } else {
            count.style.color = '#27AE60';
        }
    }
    
    async function enrollStudent(event) {
    event.preventDefault();
    
    // CHECK LICENSE FIRST
    try {
        const licenseCheck = await fetch('/api/license/status');
        const licenseData = await licenseCheck.json();
        
        if (!licenseData.valid) {
            showMessage('‚ùå No valid license! Please purchase a license in the License page.', 'error');
            setTimeout(() => {
                window.location.href = '/license';
            }, 2000);
            return;
        }
        
        if (licenseData.students_available <= 0) {
            showMessage('‚ùå You have 0 students available. Please purchase more in the License page.', 'error');
            setTimeout(() => {
                window.location.href = '/license';
            }, 2000);
            return;
        }
    } catch (error) {
        showMessage('‚ö†Ô∏è Could not verify license status. Please check your connection.', 'error');
        return;
    }
    
    if (selectedPhotos.length === 0) {
        showMessage('Please select at least one reference photo', 'error');
        return;
    }
    
    // Proceed with enrollment
    const formData = new FormData(event.target);
    
    // Add selected photos
    selectedPhotos.forEach(photo => {
        formData.append('photos', photo);
    });
    
    const btn = document.getElementById('enrollBtn');
    btn.disabled = true;
    btn.textContent = ' Enrolling...';
    
    try {
        const response = await fetch('/api/enroll', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showMessage(' ' + data.message, 'success');
            
            // Clear form
            event.target.reset();
            selectedPhotos = [];
            document.getElementById('photoPreview').innerHTML = '';
            updatePhotoCount();
            
            // Reload page after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showMessage(' ' + (data.detail || data.message || 'Enrollment failed'), 'error');
        }
    } catch (error) {
        console.error('Enrollment error:', error);
        showMessage(' Failed to enroll student: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = ' Enroll Student';
    }
}
    
    // ... rest of the function
    
    async function deleteStudent(studentId, studentName) {
        if (!confirm(`Delete ${studentName}? This will remove all their data and face matches.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/api/students/${studentId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage('Student deleted successfully', 'success');
                setTimeout(() => window.location.reload(), 1000);
            }
        } catch (error) {
            showMessage('Failed to delete student', 'error');
        }
    }
    
    function filterStudents() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const table = document.getElementById('studentsTable');
        if (!table) return;
        
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }
</script>
{% endblock %}