{% extends "base.html" %}

{% block title %}Review Matches - TLP Photo App{% endblock %}

{% block extra_css %}
<style>
    .review-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
    }
    
    .comparison-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .face-viewer, .reference-viewer {
        background: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
    }
    
    .face-viewer h3, .reference-viewer h3 {
        margin-bottom: 15px;
        color: #2C3E50;
        font-size: 18px;
    }
    
    .face-image, .reference-image {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        border: 3px solid #E8E8E8;
        margin-bottom: 10px;
    }
    
    .face-viewer {
        border: 3px solid #3498DB;
    }
    
    .reference-viewer {
        border: 3px solid #2ECC71;
    }
    
    .reference-thumbnails {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 15px;
    }
    
    .ref-thumb {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #E8E8E8;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .ref-thumb:hover {
        border-color: #2ECC71;
        transform: scale(1.1);
    }
    
    .ref-thumb.active {
        border-color: #2ECC71;
        border-width: 3px;
    }
    
    .match-info {
        background: #F8F9FA;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        text-align: left;
    }
    
    .match-info p {
        margin: 10px 0;
        color: #2C3E50;
    }
    
    .confidence-bar {
        width: 100%;
        height: 30px;
        background: #E8E8E8;
        border-radius: 8px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #E74C3C 0%, #F39C12 50%, #2ECC71 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
    }
    
    .student-selector {
        margin: 20px 0;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }
    
    .action-buttons button {
        flex: 1;
        padding: 15px;
        font-size: 16px;
    }
    
    .side-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    @media (max-width: 1024px) {
        .review-container {
            grid-template-columns: 1fr;
        }
        
        .comparison-section {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>‚úì Review Face Matches</h1>
</div>

{% if not session %}
<div class="alert alert-info">
    ‚ö† No active session. Please create or select a session first.
</div>
{% else %}

<div id="statusMessage" class="alert alert-success" style="display: none;"></div>

<div class="card">
    <h2>Review Progress</h2>
    <p id="progressText" style="font-size: 18px; font-weight: 600; color: #3498DB; margin-bottom: 20px;">
        Loading...
    </p>
    
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="previousFace()" id="prevBtn">
            ‚¨Ö Previous
        </button>
        <button class="btn btn-primary" onclick="nextFace()" id="nextBtn">
            Skip ‚è≠
        </button>
        <button class="btn btn-success" onclick="refreshReview()">
            üîÑ Refresh
        </button>
    </div>
</div>

<div id="reviewContent" style="display: none;">
    <div class="comparison-section">
        <div class="face-viewer">
            <h3>üì∑ Face to Review</h3>
            <div id="faceImageContainer">
                <p class="loading">Loading...</p>
            </div>
        </div>
        
        <div class="reference-viewer">
            <h3>üë§ Reference Photo(s)</h3>
            <div id="referenceImageContainer">
                <p class="loading">Select a student</p>
            </div>
            <div id="referenceThumbnails" class="reference-thumbnails"></div>
        </div>
    </div>
    
    <div class="card">
        <h2>Match Information</h2>
        <div id="matchInfo">
            <p class="loading">Loading...</p>
        </div>
        
        <div class="student-selector">
            <label style="display: block; margin-bottom: 10px; font-weight: 600;">
                Assign to Student:
            </label>
            <select id="studentSelect" class="form-control" style="margin-bottom: 15px;" onchange="updateReferencePhotos()">
                <option value="">-- Select Student --</option>
            </select>
            <button class="btn btn-success" style="width: 100%;" onclick="confirmMatch()">
                ‚úì Confirm Match
            </button>
        </div>
    </div>
</div>

<div id="completedMessage" style="display: none;">
    <div class="card">
        <div style="text-align: center; padding: 60px 20px;">
            <h2 style="color: #2ECC71; font-size: 48px; margin-bottom: 20px;">‚úì</h2>
            <h2 style="color: #2ECC71;">All Done!</h2>
            <p style="color: #7F8C8D; margin-top: 10px; font-size: 18px;">
                No faces need review. All matches have been confirmed.
            </p>
        </div>
    </div>
</div>

{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    let faces = [];
    let currentIndex = 0;
    let students = [];
    let currentReferencePhotos = [];
    
    async function loadReview() {
        try {
            // Load faces needing review
            const facesResponse = await fetch('/api/review/faces');
            faces = await facesResponse.json();
            
            // Load students
            const studentsResponse = await fetch('/api/students');
            students = await studentsResponse.json();
            
            if (faces.length === 0) {
                document.getElementById('reviewContent').style.display = 'none';
                document.getElementById('completedMessage').style.display = 'block';
                document.getElementById('progressText').textContent = '‚úì All faces reviewed';
                return;
            }
            
            document.getElementById('reviewContent').style.display = 'block';
            document.getElementById('completedMessage').style.display = 'none';
            
            // Populate student dropdown
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">-- Select Student --</option>';
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.full_name} (${student.state_code})`;
                select.appendChild(option);
            });
            
            showCurrentFace();
            
        } catch (error) {
            console.error('Error loading review data:', error);
            showMessage('Failed to load review data', 'error');
        }
    }
    
    function showCurrentFace() {
        if (!faces.length) return;
        
        const face = faces[currentIndex];
        
        // Update progress
        document.getElementById('progressText').textContent = 
            `Face ${currentIndex + 1} of ${faces.length}`;
        
        // Show face image
        const faceContainer = document.getElementById('faceImageContainer');
        faceContainer.innerHTML = `<img src="/photo/${face.photo_id}" class="face-image" alt="Face to review">`;
        
        // Build match info
        let matchInfoHtml = `
            <p><strong>Confidence:</strong></p>
            <div class="confidence-bar">
                <div class="confidence-fill" style="width: ${(face.match_confidence * 100).toFixed(0)}%">
                    ${(face.match_confidence * 100).toFixed(1)}%
                </div>
            </div>
        `;
        
        if (face.suggested_student) {
            matchInfoHtml += `
                <p><strong>Suggested Match:</strong> ${face.suggested_student.name}</p>
                <p><strong>State Code:</strong> ${face.suggested_student.state_code}</p>
            `;
            
            // Pre-select suggested student
            document.getElementById('studentSelect').value = face.suggested_student.id;
            
            // Show reference photos
            updateReferencePhotos();
        } else {
            matchInfoHtml += `<p style="color: #E67E22;"><strong>No match found</strong></p>`;
            document.getElementById('studentSelect').value = '';
            document.getElementById('referenceImageContainer').innerHTML = 
                '<p style="color: #7F8C8D;">Select a student to see reference photos</p>';
            document.getElementById('referenceThumbnails').innerHTML = '';
        }
        
        document.getElementById('matchInfo').innerHTML = matchInfoHtml;
    }
    
    function updateReferencePhotos() {
        const studentId = document.getElementById('studentSelect').value;
        
        if (!studentId) {
            document.getElementById('referenceImageContainer').innerHTML = 
                '<p style="color: #7F8C8D;">Select a student to see reference photos</p>';
            document.getElementById('referenceThumbnails').innerHTML = '';
            return;
        }
        
        // Find student
        const student = students.find(s => s.id == studentId);
        if (!student) return;
        
        // Find suggested student with reference photos
        const face = faces[currentIndex];
        let refPhotos = [];
        
        if (face.suggested_student && face.suggested_student.id == studentId) {
            refPhotos = face.suggested_student.reference_photos || [];
        }
        
        if (refPhotos.length === 0) {
            document.getElementById('referenceImageContainer').innerHTML = 
                '<p style="color: #E67E22;">No reference photos available</p>';
            document.getElementById('referenceThumbnails').innerHTML = '';
            return;
        }
        
        currentReferencePhotos = refPhotos;
        
        // Show first reference photo
        showReferencePhoto(0);
        
        // Show thumbnails if multiple photos
        if (refPhotos.length > 1) {
            const thumbsContainer = document.getElementById('referenceThumbnails');
            thumbsContainer.innerHTML = '';
            
            refPhotos.forEach((photo, index) => {
                const img = document.createElement('img');
                img.src = `/reference/${studentId}/${index}`;
                img.className = `ref-thumb ${index === 0 ? 'active' : ''}`;
                img.alt = `Reference ${index + 1}`;
                img.onclick = () => showReferencePhoto(index);
                thumbsContainer.appendChild(img);
            });
        } else {
            document.getElementById('referenceThumbnails').innerHTML = '';
        }
    }
    
    function showReferencePhoto(index) {
        const studentId = document.getElementById('studentSelect').value;
        const refContainer = document.getElementById('referenceImageContainer');
        
        refContainer.innerHTML = `
            <img src="/reference/${studentId}/${index}" class="reference-image" alt="Reference photo">
            <p style="color: #7F8C8D; font-size: 12px; margin-top: 10px;">
                Reference Photo ${index + 1} of ${currentReferencePhotos.length}
            </p>
        `;
        
        // Update active thumbnail
        document.querySelectorAll('.ref-thumb').forEach((thumb, i) => {
            thumb.classList.toggle('active', i === index);
        });
    }
    
    async function confirmMatch() {
        const studentId = document.getElementById('studentSelect').value;
        
        if (!studentId) {
            showMessage('Please select a student', 'error');
            return;
        }
        
        const face = faces[currentIndex];
        
        try {
            const formData = new FormData();
            formData.append('student_id', studentId);
            
            const response = await fetch(`/api/review/${face.id}/confirm`, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage('Match confirmed!', 'success');
                
                // Remove from list and move to next
                faces.splice(currentIndex, 1);
                
                if (faces.length === 0) {
                    document.getElementById('reviewContent').style.display = 'none';
                    document.getElementById('completedMessage').style.display = 'block';
                    document.getElementById('progressText').textContent = '‚úì All faces reviewed';
                } else {
                    if (currentIndex >= faces.length) {
                        currentIndex = faces.length - 1;
                    }
                    showCurrentFace();
                }
            }
            
        } catch (error) {
            showMessage('Failed to confirm match', 'error');
        }
    }
    
    function previousFace() {
        if (currentIndex > 0) {
            currentIndex--;
            showCurrentFace();
        }
    }
    
    function nextFace() {
        if (currentIndex < faces.length - 1) {
            currentIndex++;
            showCurrentFace();
        }
    }
    
    function refreshReview() {
        currentIndex = 0;
        loadReview();
    }
    
    function showMessage(message, type) {
        const msgDiv = document.getElementById('statusMessage');
        msgDiv.className = `alert alert-${type}`;
        msgDiv.textContent = message;
        msgDiv.style.display = 'block';
        
        setTimeout(() => {
            msgDiv.style.display = 'none';
        }, 3000);
    }
    
    // Load on page load
    loadReview();
</script>
{% endblock %}